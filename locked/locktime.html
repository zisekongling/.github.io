<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青春时光 - 高考倒计时优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #6e8efb;
            --secondary: #a777e3;
            --accent: #ff6b6b;
            --text: #333;
            --bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.92);
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --gaokao-color: #ff6b6b;
            --progress-normal: #2ecc71;
            --progress-warning: #e74c3c;
        }
        .dark-theme {
            --primary: #8aa2ff;
            --secondary: #c097f5;
            --accent: #ff8e8e;
            --text: #f0f0f0;
            --bg: #1a1a2e;
            --card-bg: rgba(30, 30, 46, 0.92);
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            --gaokao-color: #ff8e8e;
        }
        .ocean-theme {
            --primary: #3498db;
            --secondary: #1abc9c;
            --accent: #9b59b6;
            --text: #2c3e50;
            --bg: #ecf0f1;
            --card-bg: rgba(236, 240, 241, 0.92);
            --gaokao-color: #e74c3c;
        }
        .forest-theme {
            --primary: #27ae60;
            --secondary: #f39c12;
            --accent: #c0392b;
            --text: #34495e;
            --bg: #ecf0f1;
            --card-bg: rgba(236, 240, 241, 0.92);
            --gaokao-color: #16a085;
        }
        .sunset-theme {
            --primary: #e74c3c;
            --secondary: #e67e22;
            --accent: #9b59b6;
            --text: #2c3e50;
            --bg: #f5d76e;
            --card-bg: rgba(245, 215, 110, 0.92);
            --gaokao-color: #c0392b;
        }
        .midnight-theme {
            --primary: #8e44ad;
            --secondary: #3498db;
            --accent: #1abc9c;
            --text: #ecf0f1;
            --bg: #2c3e50;
            --card-bg: rgba(44, 62, 80, 0.92);
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            --gaokao-color: #9b59b6;
        }
        .sakura-theme {
            --primary: #e84393;
            --secondary: #fd79a8;
            --accent: #6c5ce7;
            --text: #2d3436;
            --bg: #ffcccc;
            --card-bg: rgba(255, 204, 204, 0.92);
            --gaokao-color: #e84393;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            overflow: hidden;
            position: relative;
            padding: 15px;
            background-size: cover;
            background-position: center;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo h1 {
            font-size: 1.6rem;
            background: linear-gradient(45deg, var(--accent), #ffa502);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .logo i {
            font-size: 1.8rem;
            color: var(--accent);
        }
        .gaokao-countdown {
            font-size: 1.1rem;
            background: rgba(255, 107, 107, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            color: var(--gaokao-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            text-align: center;
            line-height: 1.3;
            animation: pulse 2s infinite;
        }
        .next-exam {
            font-size: 1rem;
            background: rgba(106, 17, 203, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            text-align: center;
            line-height: 1.3;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            font-size: 1rem;
            position: relative;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-small {
            padding: 5px 12px;
            font-size: 0.9rem;
        }
        .tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .btn:hover .tooltip {
            opacity: 1;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.4s ease;
        }
        .settings-open .main-content {
            transform: translateY(-100%);
        }
        .time-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .date-display {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
            text-align: center;
        }
        .time-display {
            font-size: 4.5rem;
            font-weight: 800;
            color: var(--text);
            text-align: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 5px;
            transition: font-size 0.3s ease;
        }
        .milliseconds {
            font-size: 2.2rem;
            color: var(--accent);
            align-self: flex-end;
            margin-bottom: 5px;
        }
        .quote-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            min-height: 200px;
            transition: all 0.3s ease;
        }
        .quote-priority .time-section {
            flex: 1;
        }
        .quote-priority .quote-section {
            flex: 2;
        }
        .quote-priority .time-display {
            font-size: 3.8rem;
        }
        .quote-priority .quote-content {
            font-size: 2rem;
        }
        .time-priority .time-section {
            flex: 2;
        }
        .time-priority .quote-section {
            flex: 1;
        }
        .time-priority .time-display {
            font-size: 5.5rem;
        }
        .time-priority .quote-content {
            font-size: 1.6rem;
        }
        .quote-hidden .quote-section {
            display: none;
        }
        .quote-hidden .time-section {
            height: 70vh;
            justify-content: center;
        }
        .quote-hidden .time-display {
            font-size: 6.5rem !important;
        }
        .quote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .quote-header h2 {
            font-size: 1.4rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quote-content {
            font-size: 1.8rem;
            line-height: 1.4;
            text-align: center;
            color: var(--text);
            font-style: italic;
            margin: 15px 0;
            padding: 0 15px;
            position: relative;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quote-content::before,
        .quote-content::after {
            content: '"';
            font-size: 3rem;
            color: rgba(106, 17, 203, 0.2);
            position: absolute;
        }
        .quote-content::before {
            top: -20px;
            left: -10px;
        }
        .quote-content::after {
            bottom: -35px;
            right: -10px;
        }
        .quote-author {
            font-size: 1.3rem;
            text-align: right;
            color: var(--text);
            opacity: 0.8;
            margin-top: 20px;
            padding-right: 15px;
            font-weight: 500;
        }
        .quote-type {
            background: rgba(106, 17, 203, 0.1);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.95rem;
            position: absolute;
            bottom: 15px;
            left: 15px;
        }
        .cursor {
            display: inline-block;
            width: 2px;
            height: 2rem;
            background: var(--accent);
            margin-left: 3px;
            vertical-align: middle;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .settings-panel {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            transform: translateY(0);
            transition: transform 0.4s ease;
            z-index: 10;
        }
        .settings-open .settings-panel {
            transform: translateY(-100%);
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .settings-header h2 {
            font-size: 1.6rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .settings-buttons {
            display: flex;
            gap: 10px;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        .settings-grid::-webkit-scrollbar {
            width: 8px;
        }
        .settings-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .settings-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        .setting-group {
            background: rgba(245, 245, 245, 0.3);
            padding: 15px;
            border-radius: 16px;
        }
        .dark-theme .setting-group,
        .ocean-theme .setting-group,
        .forest-theme .setting-group,
        .sunset-theme .setting-group,
        .midnight-theme .setting-group,
        .sakura-theme .setting-group {
            background: rgba(40, 40, 60, 0.5);
        }
        .setting-group h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
        }
        .checkbox-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1rem;
        }
        .background-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .bg-input-group {
            display: flex;
            gap: 10px;
        }
        .bg-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.5);
        }
        .dark-theme .bg-input,
        .ocean-theme .bg-input,
        .forest-theme .bg-input,
        .sunset-theme .bg-input,
        .midnight-theme .bg-input,
        .sakura-theme .bg-input {
            background: rgba(30, 30, 50, 0.5);
            color: var(--text);
            border-color: #444;
        }
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .preset-btn {
            flex: 1;
            min-width: 110px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(110, 142, 251, 0.15);
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        .preset-btn:hover {
            background: rgba(110, 142, 251, 0.25);
            transform: translateY(-2px);
        }
        .preset-btn.active {
            background: var(--primary);
            color: white;
        }
        .interval-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        .interval-control {
            flex: 1;
            min-width: 200px;
        }
        .interval-control label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--primary);
            font-size: 1rem;
        }
        .interval-control input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.5);
            font-size: 1.05rem;
        }
        .dark-theme .interval-control input,
        .ocean-theme .interval-control input,
        .forest-theme .interval-control input,
        .sunset-theme .interval-control input,
        .midnight-theme .interval-control input,
        .sakura-theme .interval-control input {
            background: rgba(30, 30, 50, 0.5);
            color: var(--text);
            border-color: var(--secondary);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(110, 142, 251, 0.15);
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .action-btn:hover {
            background: rgba(110, 142, 251, 0.25);
            transform: translateY(-2px);
        }
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(106, 17, 203, 0.05);
            font-size: 0.95rem;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2ecc71;
        }
        .status-indicator.offline {
            background: #e74c3c;
        }
        .download-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            margin-left: 5px;
        }
        .download-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }
        .pulse {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .floating-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
            border: none;
        }
        .floating-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }
        .floating-btn:hover {
            transform: translateY(-5px) rotate(15deg);
        }
        .type-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .blink-colon {
            animation: blink 1s infinite;
        }
        .progress-container {
            position: absolute;
            height: 5px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 100%;
            transform-origin: left;
            transform: scaleX(1);
            transition: transform 0.3s linear;
        }
        .bg-progress {
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .toast {
            position: fixed;
            top: 25px;
            right: 25px;
            background: var(--card-bg);
            color: var(--text);
            padding: 18px 28px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast i {
            font-size: 1.6rem;
            color: #2ecc71;
        }
        .reset-btn {
            background: rgba(255, 107, 107, 0.1);
            color: var(--gaokao-color);
            border: 1px solid var(--gaokao-color);
        }
        .reset-btn:hover {
            background: rgba(255, 107, 107, 0.2);
        }
        .quote-progress-container {
            width: 120px;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-left: 12px;
        }
        .quote-progress-bar {
            height: 100%;
            width: 100%;
            transform-origin: left;
            transform: scaleX(0);
            transition: transform 0.3s linear;
        }
        .performance-indicator {
            position: fixed;
            bottom: 25px;
            right: 100px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 99;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .performance-indicator.normal {
            background: #2ecc71;
            color: white;
        }
        .performance-indicator.powersave {
            background: #f39c12;
            color: white;
        }
        .performance-indicator.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(20px);
        }
        .performance-indicator:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            margin-bottom: 8px;
        }
        
        /* 防休眠模式状态指示器 */
        .no-sleep-indicator {
            position: fixed;
            bottom: 25px;
            left: 25px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 99;
        }
        .no-sleep-indicator .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #2ecc71;
            animation: pulse 1.5s infinite;
        }
        .no-sleep-indicator .indicator.inactive {
            background-color: #e74c3c;
        }
        
        /* 2K屏幕优化 */
        @media (min-width: 1920px) {
            .container {
                max-width: 1400px;
            }
            .time-display {
                font-size: 5rem;
            }
            .quote-content {
                font-size: 2.2rem;
            }
            .time-section {
                padding: 40px;
            }
            .quote-section {
                padding: 40px;
            }
            .time-priority .time-display {
                font-size: 6.5rem;
            }
            .quote-priority .quote-content {
                font-size: 2.4rem;
            }
        }
        /* 超宽屏适配 */
        @media (min-width: 2500px) {
            .container {
                max-width: 1800px;
            }
            .time-display {
                font-size: 6rem;
            }
            .quote-content {
                font-size: 2.5rem;
            }
            .time-section {
                padding: 50px;
            }
            .quote-section {
                padding: 50px;
                min-height: 250px;
            }
            .quote-header h2 {
                font-size: 1.8rem;
            }
            .quote-author {
                font-size: 1.6rem;
            }
            .logo h1 {
                font-size: 2rem;
            }
            .gaokao-countdown {
                font-size: 1.3rem;
            }
            .btn {
                font-size: 1.2rem;
                padding: 10px 20px;
            }
        }
        @media (max-width: 900px) and (orientation: portrait) {
            .container {
                max-width: 95%;
            }
            .time-display {
                font-size: 3.8rem;
            }
            .quote-content {
                font-size: 1.6rem;
            }
            .time-section {
                padding: 20px;
            }
            .quote-section {
                padding: 20px;
            }
        }
        @media (max-width: 900px) and (orientation: landscape) {
            .container {
                max-width: 95%;
            }
            .time-display {
                font-size: 3.5rem;
            }
            .quote-content {
                font-size: 1.4rem;
            }
            .time-section {
                padding: 15px;
            }
            .quote-section {
                padding: 15px;
            }
            .settings-grid {
                max-height: 60vh;
            }
        }
        @media (max-width: 768px) {
            .logo h1 {
                font-size: 1.4rem;
                gap: 8px;
            }
            .gaokao-countdown {
                font-size: 0.95rem;
                padding: 4px 8px;
            }
            .btn {
                padding: 7px 14px;
                font-size: 0.9rem;
            }
            .time-display {
                font-size: 3.5rem;
            }
            .milliseconds {
                font-size: 1.8rem;
            }
            .quote-hidden .time-display {
                font-size: 5.5rem !important;
            }
            .quote-content {
                font-size: 1.5rem;
                min-height: 100px;
            }
            .quote-author {
                font-size: 1.1rem;
            }
            .preset-btn {
                min-width: 90px;
                font-size: 0.85rem;
            }
            .quote-progress-container {
                width: 90px;
            }
        }
        @media (max-width: 600px) {
            .time-display {
                font-size: 3rem;
            }
            .quote-hidden .time-display {
                font-size: 4.5rem !important;
            }
            .quote-content {
                font-size: 1.4rem;
            }
            .interval-controls {
                flex-direction: column;
            }
            .interval-control {
                min-width: 100%;
            }
            .quote-progress-container {
                width: 70px;
            }
        }
        @media (max-width: 480px) {
            header {
                flex-direction: column;
                gap: 12px;
                padding: 12px;
            }
            .controls {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            .logo {
                justify-content: center;
                width: 100%;
            }
            .logo h1 {
                justify-content: center;
                text-align: center;
            }
            .time-display {
                font-size: 2.8rem;
            }
            .milliseconds {
                font-size: 1.4rem;
            }
            .quote-hidden .time-display {
                font-size: 4rem !important;
            }
            .date-display {
                font-size: 1.2rem;
            }
            .quote-content {
                font-size: 1.3rem;
            }
            .quote-author {
                font-size: 1rem;
            }
            .bg-input-group {
                flex-direction: column;
            }
            .preset-buttons {
                flex-direction: column;
            }
            .preset-btn {
                width: 100%;
            }
            .quote-progress-container {
                width: 60px;
            }
            .btn .tooltip {
                display: none;
            }
            .settings-grid {
                max-height: 60vh;
            }
            .action-buttons {
                flex-direction: column;
            }
            .performance-indicator {
                bottom: 95px;
                right: 25px;
            }
            .no-sleep-indicator {
                bottom: 95px;
                left: 15px;
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
        @media (max-width: 360px) {
            .time-display {
                font-size: 2.5rem;
            }
            .quote-hidden .time-display {
                font-size: 3.5rem !important;
            }
            .date-display {
                font-size: 1.1rem;
            }
            .quote-content {
                font-size: 1.2rem;
            }
        }
        @media (max-width: 360px) and (orientation: portrait) {
            .time-display {
                font-size: 2.2rem;
            }
            .quote-hidden .time-display {
                font-size: 3rem !important;
            }
            .date-display {
                font-size: 0.95rem;
            }
            .quote-content {
                font-size: 1.1rem;
                min-height: 90px;
            }
            .quote-section {
                padding: 15px;
            }
            .logo h1 {
                font-size: 1.2rem;
            }
            .time-section {
                padding: 15px;
            }
        }
        @media (max-height: 480px) and (orientation: landscape) {
            .container {
                max-width: 95%;
                gap: 10px;
            }
            .time-section {
                padding: 15px;
            }
            .quote-section {
                padding: 15px;
                min-height: 150px;
            }
            .time-display {
                font-size: 2.8rem;
            }
            .quote-content {
                font-size: 1.2rem;
                min-height: 80px;
            }
            .quote-author {
                font-size: 0.9rem;
                margin-top: 10px;
            }
            .settings-grid {
                max-height: 50vh;
            }
            header {
                padding: 8px 12px !important;
            }
            .logo h1 {
                font-size: 1.2rem !important;
            }
            .gaokao-countdown {
                font-size: 0.85rem !important;
            }
            .btn {
                padding: 5px 10px !important;
                font-size: 0.85rem !important;
            }
        }
        @media (max-height: 400px) and (orientation: landscape) {
            .time-display {
                font-size: 2.5rem !important;
            }
            .quote-content {
                font-size: 1.1rem !important;
                min-height: 70px;
            }
            .quote-author, .quote-type {
                font-size: 0.8rem !important;
            }
            .time-section {
                padding: 10px !important;
            }
            .quote-section {
                padding: 10px !important;
            }
            .date-display {
                font-size: 1rem !important;
            }
        }
        @media (max-height: 600px) {
            .quote-section {
                padding: 15px !important;
            }
            .quote-content {
                font-size: 1.4rem !important;
                min-height: 80px;
            }
            .quote-author, .quote-type {
                font-size: 1rem !important;
            }
        }
        @media (max-height: 500px) {
            .quote-content {
                font-size: 1.3rem !important;
                min-height: 70px;
            }
            .quote-author, .quote-type {
                font-size: 0.9rem !important;
            }
        }
        @media (max-height: 400px) {
            .quote-content {
                font-size: 1.1rem !important;
                min-height: 60px;
            }
            .quote-author, .quote-type {
                font-size: 0.8rem !important;
            }
        }
        /* 科目设置样式 */
        .subject-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .subject-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
        }
        .subject-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        .next-exam-container {
            margin-left: 10px;
            display: none;
        }
        .gaokao-exam {
            display: flex;
            align-items: center;
            gap: 8px;
        }
.auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.auth-content {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 15px;
    box-shadow: var(--shadow);
    width: 90%;
    max-width: 400px;
    text-align: center;
}

.auth-content h3 {
    font-size: 1.5rem;
    margin-bottom: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.auth-content p {
    margin-bottom: 20px;
    font-size: 1.1rem;
}

.auth-input {
    margin-bottom: 20px;
}

.auth-input input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--primary);
    border-radius: 10px;
    font-size: 1.3rem;
    text-align: center;
    letter-spacing: 2px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
}

.auth-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.auth-buttons .btn {
    flex: 1;
    min-width: 120px;
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-clock"></i>
                <h1>
                    青春时光
                    <span class="gaokao-countdown" id="gaokaoCountdown">
                        <i class="fas fa-graduation-cap"></i>
                        <span id="gaokaoText">高考倒计时计算中...</span>
                    </span>
                    <span class="next-exam-container" id="nextExamContainer">
                        <span class="next-exam" id="nextExam">
                            <i class="fas fa-book-open"></i>
                            <span id="nextExamText">下一科：语文</span>
                        </span>
                    </span>
                </h1>
            </div>
            <div class="controls">
                <button type="button" class="btn btn-outline" id="themeBtn" aria-label="切换主题">
                    <i class="fas fa-sync-alt"></i>
                    <span class="tooltip">切换主题</span>
                </button>
                <button type="button" class="btn" id="fullscreenBtn" aria-label="全屏显示">
                    <i class="fas fa-expand"></i>
                    <span class="tooltip">全屏显示</span>
                </button>
                <button type="button" class="btn" id="settingsBtn">
                    <i class="fas fa-cog"></i> 设置
                    <span class="tooltip">个性化设置</span>
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="time-section">
                <div class="date-display" id="dateDisplay">2023年10月15日 星期日</div>
                <div class="time-display">
                    <span id="hours">14</span>
                    <span class="colon" id="colonAfterHour">:</span>
                    <span id="minutes">30</span>
                    <span class="colon" id="colonAfterMinute">:</span>
                    <span id="seconds">45</span>
                    <span class="milliseconds">.<span id="milliseconds">789</span></span>
                </div>
            </div>
            
            <div class="quote-section">
                <div class="quote-header">
                    <h2><i class="fas fa-quote-left"></i> 每日金句</h2>
                    <div class="api-status" id="apiStatusContainer">
                        <div class="status-indicator" id="apiStatus"></div>
                        <span id="apiStatusText">API正常</span>
                        <div class="quote-progress-container">
                            <div class="quote-progress-bar" id="quoteProgressBar"></div>
                        </div>
                    </div>
                </div>
                <div class="quote-content" id="quoteContent">
                    生活就像骑自行车，为了保持平衡，你必须不断前进。<span class="cursor"></span>
                </div>
                <div class="quote-author" id="quoteAuthor">—— 爱因斯坦 · 物理学家</div>
                <div class="quote-type" id="quoteType">哲学</div>
            </div>
        </div>
        
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2><i class="fas fa-cog"></i> 个性化设置</h2>
                <div class="settings-buttons">
                    <button type="button" class="btn btn-outline" id="cancelSettingsBtn">
                        <i class="fas fa-times"></i> 取消更改
                    </button>
                    <button type="button" class="btn" id="saveSettingsBtn" style="margin-left: 10px;">
                        <i class="fas fa-check"></i> 保存并退出
                    </button>
                </div>
            </div>
            
            <div class="settings-grid">
                <div class="setting-group">
                    <h3><i class="fas fa-clock"></i> 时间显示设置</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="showDate" checked> 显示日期
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="showSeconds" checked> 显示秒钟
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="showMilliseconds"> 显示毫秒
                        </label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-balance-scale"></i> 显示偏好</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="displayPriority" id="quotePriority" value="quote" checked> 金句优先
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="displayPriority" id="timePriority" value="time"> 时间优先
                        </label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-palette"></i> 背景设置</h3>
                    <div class="background-options">
                        <div class="bg-input-group">
                            <input type="text" id="bgUrl" class="bg-input" placeholder="输入背景图片URL">
                            <button type="button" class="btn" id="saveBgBtn" aria-label="保存背景">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                        <button type="button" class="btn" id="bgLocalBtn">
                            <i class="fas fa-image"></i> 选择本地图片
                        </button>
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn" data-preset="none">无背景</button>
                            <button type="button" class="preset-btn" data-preset="weimei">唯美</button>
                            <button type="button" class="preset-btn" data-preset="bluearchive">蔚蓝档案</button>
                            <button type="button" class="preset-btn" data-preset="anime">二次元</button>
                            <button type="button" class="preset-btn" data-preset="yuanshen">原神</button>
                            <button type="button" class="preset-btn" data-preset="random">随机</button>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-quote-right"></i> 金句类型设置</h3>
                    <div class="type-controls">
                        <button type="button" class="btn btn-small" id="selectAllBtn">
                            <i class="fas fa-check-square"></i> 全选
                        </button>
                        <button type="button" class="btn btn-small btn-outline" id="deselectAllBtn">
                            <i class="far fa-square"></i> 全不选
                        </button>
                        <button type="button" class="btn btn-small" id="toggleGuaranteeBtn">
                            <i class="fas fa-shield-alt"></i> 保底机制
                        </button>
    <button type="button" class="btn btn-small" id="importExtBtn">
        <i class="fas fa-file-import"></i> 导入
    </button>
    <button type="button" class="btn btn-small" id="exportExtBtn">
        <i class="fas fa-file-export"></i> 导出
    </button>
</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="a" checked> 动画
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="b"> 漫画
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="c" checked> 游戏
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="d"> 文学
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="e"> 原创
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="f" checked> 网络
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="g"> 其他
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="h" checked> 影视
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="i"> 诗词
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="j"> 网易云
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="k" checked> 哲学
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="l"> 抖机灵
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="quoteType" value="m" id="extensionType" checked> 拓展
                        </label>
                    </div>
                    <div class="api-status">
                        <div class="status-indicator" id="extStatus"></div>
                        <span id="extStatusText">拓展金句: 已启用 (5条)</span>
                        <button type="button" class="download-btn" id="downloadExtBtn" title="重新下载拓展金句">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-history"></i> 定时设置</h3>
                    <div class="interval-controls">
                        <div class="interval-control">
                            <label for="quoteInterval">金句更换间隔 (分钟)</label>
                            <input type="number" id="quoteInterval" min="1" value="1">
                        </div>
                        <div class="interval-control">
                            <label for="bgInterval">背景更换间隔 (分钟)</label>
                            <input type="number" id="bgInterval" min="1" value="30">
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-book"></i> 高考科目设置</h3>
                    <div class="subject-group">
                         <!-- 单选组: 历史/物理 -->
    <div class="radio-group" style="width:100%; margin-bottom:15px;">
        <label class="radio-item">
            <input type="radio" name="historyPhysics" value="历 史" checked> 历 史
        </label>
        <label class="radio-item">
            <input type="radio" name="historyPhysics" value="物 理"> 物 理
        </label>
    </div>
    <!-- 多选组: 其他科目 -->
    <label class="subject-item">
        <input type="checkbox" name="ignoredSubject" value="化学" checked> 化学
    </label>
    <label class="subject-item">
        <input type="checkbox" name="ignoredSubject" value="地理" checked> 地理
    </label>
    <label class="subject-item">
        <input type="checkbox" name="ignoredSubject" value="政治" checked> 政治
    </label>
    <label class="subject-item">
        <input type="checkbox" name="ignoredSubject" value="生物" checked> 生物
    </label>
</div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-tasks"></i> 进度条设置</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="showQuoteProgress" checked> 显示金句进度条
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="showBgProgress" checked> 显示背景进度条
                        </label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-tachometer-alt"></i> 性能设置</h3>
                    <div class="interval-controls">
                        <div class="interval-control">
                            <label for="fpsThreshold">节能模式阈值 (FPS)</label>
                            <input type="number" id="fpsThreshold" min="15" max="60" value="30">
                        </div>
                        <div class="interval-control">
                            <label for="memoryThreshold">内存警告 (MB)</label>
                            <input type="number" id="memoryThreshold" min="100" max="1000" value="500">
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="powerSavingMode"> 启用节能模式
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="hidePerfIndicator" checked> 隐藏性能指示器
                        </label>
                    </div>
                    <div class="api-status" style="margin-top: 15px;">
                        <div class="status-indicator" id="perfStatus"></div>
                        <span id="perfStatusText">当前模式: 正常</span>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-sync-alt"></i> 立即操作</h3>
                    <div class="action-buttons">
                        <button type="button" class="action-btn" id="refreshQuoteBtn">
                            <i class="fas fa-quote-right"></i> 更换金句
                        </button>
                        <button type="button" class="action-btn" id="refreshBgBtn">
                            <i class="fas fa-image"></i> 更换背景
                        </button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3><i class="fas fa-redo"></i> 重置设置</h3>
                    <button type="button" class="btn reset-btn" id="resetBtn">
                        <i class="fas fa-trash-restore"></i> 恢复默认设置
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-progress progress-container" id="bgProgress">
        <div class="progress-bar" id="bgProgressBar"></div>
    </div>
    
    <button type="button" class="floating-btn" id="refreshBtn" aria-label="刷新">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <div class="performance-indicator" id="perfIndicator" data-tooltip="节能模式已开启">
        <i class="fas fa-bolt"></i>
    </div>
    
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">操作成功！</span>
    </div>
        <!-- 防休眠视频元素 -->
    <video id="noSleepVideo" playsinline muted loop style="display: none;">
        <source src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAZhtZGF0AAAAMgYF//+Z3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0OCByMjkzMSAxNzcxYjM1IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTEwIHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAABdGWIhAAv//72rvzLK0cLlS4dccVkpMgggICAgggICAF0=" type="video/mp4">
    </video>

    <script>
        // DOM元素
        const hoursEl = document.getElementById('hours');
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');
        const millisecondsEl = document.getElementById('milliseconds');
        const colonAfterHour = document.getElementById('colonAfterHour');
        const colonAfterMinute = document.getElementById('colonAfterMinute');
        const dateDisplayEl = document.getElementById('dateDisplay');
        const quoteContentEl = document.getElementById('quoteContent');
        const quoteAuthorEl = document.getElementById('quoteAuthor');
        const quoteTypeEl = document.getElementById('quoteType');
        const apiStatusEl = document.getElementById('apiStatus');
        const apiStatusTextEl = document.getElementById('apiStatusText');
        const settingsPanelEl = document.getElementById('settingsPanel');
        const containerEl = document.querySelector('.container');
        const gaokaoCountdownEl = document.getElementById('gaokaoCountdown');
        const gaokaoTextEl = document.getElementById('gaokaoText');
        const quoteProgressBar = document.getElementById('quoteProgressBar');
        const bgProgressEl = document.getElementById('bgProgress');
        const bgProgressBar = document.getElementById('bgProgressBar');
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toastMessage');
        const refreshBtnEl = document.getElementById('refreshBtn');
        const perfIndicator = document.getElementById('perfIndicator');
        const perfStatusEl = document.getElementById('perfStatus');
        const perfStatusTextEl = document.getElementById('perfStatusText');
        const noSleepVideo = document.getElementById('noSleepVideo');
        const extStatusEl = document.getElementById('extStatus');
        const extStatusTextEl = document.getElementById('extStatusText');
        const downloadExtBtn = document.getElementById('downloadExtBtn');
        const nextExamContainer = document.getElementById('nextExamContainer');
        const nextExamText = document.getElementById('nextExamText');
        
        // 设置元素
        const showDateCheckbox = document.getElementById('showDate');
        const showSecondsCheckbox = document.getElementById('showSeconds');
        const showMillisecondsCheckbox = document.getElementById('showMilliseconds');
        const showQuoteProgressCheckbox = document.getElementById('showQuoteProgress');
        const showBgProgressCheckbox = document.getElementById('showBgProgress');
        const bgUrlInput = document.getElementById('bgUrl');
        const bgLocalBtn = document.getElementById('bgLocalBtn');
        const saveBgBtn = document.getElementById('saveBgBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const themeBtn = document.getElementById('themeBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const presetBtns = document.querySelectorAll('.preset-btn');
        const quoteIntervalInput = document.getElementById('quoteInterval');
        const bgIntervalInput = document.getElementById('bgInterval');
        const refreshQuoteBtn = document.getElementById('refreshQuoteBtn');
        const refreshBgBtn = document.getElementById('refreshBgBtn');
        const resetBtn = document.getElementById('resetBtn');
        const powerSavingModeCheckbox = document.getElementById('powerSavingMode');
        const hidePerfIndicatorCheckbox = document.getElementById('hidePerfIndicator');
        const fpsThresholdInput = document.getElementById('fpsThreshold');
        const memoryThresholdInput = document.getElementById('memoryThreshold');
        const quotePriorityRadio = document.getElementById('quotePriority');
        const timePriorityRadio = document.getElementById('timePriority');
        const extensionTypeCheckbox = document.getElementById('extensionType');
        const toggleGuaranteeBtn = document.getElementById('toggleGuaranteeBtn');
        
        // 状态变量
        let currentTheme = 'light';
        const themes = ['light', 'dark', 'ocean', 'forest', 'sunset', 'midnight', 'sakura'];
        let currentThemeIndex = 0;
        let apiUrls = [
            'https://v1.hitokoto.cn',
            'https://international.v1.hitokoto.cn',
            'https://v1.hitokoto.cn' // 备用
        ];
        let currentApiIndex = 0;
        let quoteTypes = ['a', 'c', 'f', 'h', 'k'];
        let quoteInterval = 1;
        let bgIntervalTime = 30;
        let quoteStartTime = 0;
        let bgStartTime = 0;
        let quoteDuration = 0;
        let bgDuration = 0;
        let currentPreset = null;
        let customBg = null;
        let isTyping = false;
        let lastProgressUpdate = Date.now();
        let tempSettings = null;
        let animationFrameId = null;
        let quoteAnimationFrame = null;
        let bgAnimationFrame = null;
        let currentBgUrl = '';
        let powerSavingMode = false;
        let timeOffset = 0;
        let lastTimeSync = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let currentFps = 0;
        let fpsThreshold = 30;
        let memoryThreshold = 500;
        let lastMemoryCheck = 0;
        let highMemoryUsage = false;
        let powerSavingInterval = null;
        let extensionQuotes = [];
        let displayPriority = 'quote'; // 'quote' 或 'time'
        let wakeLock = null;
        let downloadRetryCount = 0;
        const maxRetries = 10;
        let consecutiveNonExtension = 0; // 连续非拓展金句计数
        let enableQuoteGuarantee = true; // 是否启用保底机制，默认开启
// 在全局变量后添加
// 生成验证密钥
function generateAuthCode() {
    const secret = 'fz222324';
    const now = new Date();
    
    // 生成时间戳 (YYYYMMDDHHMM)
    const timestamp = [
        now.getFullYear(),
        String(now.getMonth() + 1).padStart(2, '0'),
        String(now.getDate()).padStart(2, '0'),
        String(now.getHours()).padStart(2, '0'),
        String(now.getMinutes()).padStart(2, '0')
    ].join('');
    
    // 数据拼接
    const data = timestamp + secret;
    
    // 使用SHA-256哈希
    const hash = CryptoJS.SHA256(data);
    const hashHex = hash.toString(CryptoJS.enc.Hex);
    
    // 将哈希值转换为BigInt
    const bigIntValue = BigInt('0x' + hashHex);
    
    // Base58字符集 (去除了0、O、I、l等容易混淆的字符)
    const base58Chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    
    // Base58编码
    let base58 = '';
    let n = bigIntValue;
    while (n > 0) {
        const remainder = Number(n % 58n);
        n = n / 58n;
        base58 = base58Chars[remainder] + base58;
    }
    
    // 提取6位偶数索引字符
    let authCode = '';
    for (let i = 0; i <= 10; i += 2) {
        if (base58[i]) {
            authCode += base58[i];
        }
        if (authCode.length >= 6) break;
    }
    
    // 如果不足6位，用字符集开头的字符填充
    while (authCode.length < 6) {
        authCode += base58Chars[0];
    }
    
    return authCode;
}

        // 高考科目时间表
        const examSubjects = [
            { name: "语文", date: "06-07", startTime: "09:00", endTime: "11:30" },
            { name: "数学", date: "06-07", startTime: "15:00", endTime: "17:00" },
            { name: "物理/历史", date: "06-08", startTime: "09:00", endTime: "10:15" },
            { name: "外语", date: "06-08", startTime: "15:00", endTime: "17:00" },
            { name: "化学", date: "06-09", startTime: "08:30", endTime: "09:45" },
            { name: "地理", date: "06-09", startTime: "11:00", endTime: "12:15" },
            { name: "政治", date: "06-09", startTime: "14:30", endTime: "15:45" },
            { name: "生物", date: "06-09", startTime: "17:00", endTime: "18:15" }
        ];
        
        // 被忽略的科目
        let ignoredSubjects = [];

        // 示例扩展金句JSON数据
        const sampleExtensionQuotes = [
            {
                "hitokoto": "生活不止眼前的苟且，还有诗和远方。",
                "from": "高晓松",
                "from_who": "",
                "type": "m"
            },
            {
                "hitokoto": "成功的秘诀在于坚持自己的梦想。",
                "from": "马云",
                "from_who": "",
                "type": "m"
            },
            {
                "hitokoto": "学习如逆水行舟，不进则退。",
                "from": "《增广贤文》",
                "from_who": "",
                "type": "m"
            },
            {
                "hitokoto": "世上无难事，只要肯登攀。",
                "from": "毛泽东",
                "from_who": "",
                "type": "m"
            },
            {
                "hitokoto": "知识就是力量。",
                "from": "培根",
                "from_who": "",
                "type": "m"
            }
        ];
        
        // 更新拓展金句状态显示
        function updateExtensionStatus() {
            const savedQuotes = localStorage.getItem('extensionQuotes');
            if (savedQuotes) {
                try {
                    const quotes = JSON.parse(savedQuotes);
                    extStatusEl.className = 'status-indicator';
                    extStatusTextEl.textContent = `拓展金句: 已启用 (${quotes.length}条)`;
                } catch (e) {
                    extStatusEl.className = 'status-indicator offline';
                    extStatusTextEl.textContent = '拓展金句: 数据损坏';
                }
            } else {
                extStatusEl.className = 'status-indicator offline';
                extStatusTextEl.textContent = '拓展金句: 已禁用';
            }
        }
        
        // 防休眠模式函数
        async function enableNoSleep() {
            try {
                // 尝试使用Wake Lock API
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock was released');
                    });
                    console.log('Wake Lock is active');
                } else {
                    // 如果不支持Wake Lock API，使用视频播放方式
                    try {
                        await noSleepVideo.play();
                        console.log('Video is playing to prevent sleep');
                    } catch (error) {
                        console.error('Failed to play video for no sleep:', error);
                    }
                }
            } catch (error) {
                console.error('Failed to enable no sleep mode:', error);
            }
        }

        // 下载扩展金句JSON
        async function downloadExtensionQuotes() {
            try {
                // 显示下载状态
                extStatusEl.className = 'status-indicator pulse';
                extStatusTextEl.textContent = '下载中...';
                
                // 使用CORS代理并添加时间戳防止缓存
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = 'https://gitee.com/zisekongling/apk-automatic-update/raw/master/time-yiyan/yiyan.json';
                const response = await fetch(`${proxyUrl}${encodeURIComponent(targetUrl)}&t=${Date.now()}`);
                
                if (!response.ok) throw new Error('扩展金句下载失败');
                
                const data = await response.json();
                const jsonData = JSON.parse(data.contents);
                if (Array.isArray(jsonData) && jsonData.length > 0) {
                    extensionQuotes = jsonData;
                    localStorage.setItem('extensionQuotes', JSON.stringify(jsonData));
                    showToast('扩展金句已更新');
                    updateExtensionStatus();
                    downloadRetryCount = 0; // 重置重试计数器
                } else {
                    throw new Error('无效的扩展金句数据');
                }
            } catch (error) {
                console.error('下载扩展金句失败:', error);
                
                // 重试机制
                if (downloadRetryCount < maxRetries) {
                    downloadRetryCount++;
                    const delay = Math.min(3000, downloadRetryCount * 500); // 指数退避
                    setTimeout(downloadExtensionQuotes, delay);
                    showToast(`下载失败，正在重试 (${downloadRetryCount}/${maxRetries})`);
                } else {
                    // 使用示例数据作为备用
                    extensionQuotes = sampleExtensionQuotes;
                    localStorage.setItem('extensionQuotes', JSON.stringify(sampleExtensionQuotes));
                    showToast('使用本地扩展金句');
                    updateExtensionStatus();
                    downloadRetryCount = 0; // 重置重试计数器
                }
            }
        }
        
        // 初始化扩展金句
        function initExtensionQuotes() {
            const savedQuotes = localStorage.getItem('extensionQuotes');
            if (savedQuotes) {
                try {
                    extensionQuotes = JSON.parse(savedQuotes);
                } catch (e) {
                    extensionQuotes = sampleExtensionQuotes;
                    localStorage.setItem('extensionQuotes', JSON.stringify(sampleExtensionQuotes));
                }
            } else {
                extensionQuotes = sampleExtensionQuotes;
            }
            
            // 更新状态显示
            updateExtensionStatus();
        }
        
        // 性能监控
        function startPerformanceMonitor() {
            setInterval(() => {
                // 检测内存使用
                if (performance.memory) {
                    const usedMB = performance.memory.usedJSHeapSize / (1024 * 1024);
                    if (usedMB > memoryThreshold && !highMemoryUsage) {
                        highMemoryUsage = true;
                        showToast(`内存使用过高: ${usedMB.toFixed(2)}MB`);
                    } else if (usedMB <= memoryThreshold && highMemoryUsage) {
                        highMemoryUsage = false;
                    }
                }
            }, 5000);
        }
        
        // 更新显示时间
        function updateTimeDisplay() {
            const now = new Date(Date.now() + timeOffset);
            
            hoursEl.textContent = String(now.getHours()).padStart(2, '0');
            minutesEl.textContent = String(now.getMinutes()).padStart(2, '0');
            
            if (showSecondsCheckbox.checked) {
                secondsEl.textContent = String(now.getSeconds()).padStart(2, '0');
                secondsEl.style.display = 'inline';
                colonAfterMinute.style.display = 'inline';
                if (colonAfterHour) colonAfterHour.classList.remove('blink-colon');
            } else {
                secondsEl.style.display = 'none';
                colonAfterMinute.style.display = 'none';
                if (colonAfterHour) colonAfterHour.classList.add('blink-colon');
            }
            
            if (showMillisecondsCheckbox.checked && !powerSavingMode) {
                millisecondsEl.textContent = String(now.getMilliseconds()).padStart(3, '0');
                document.querySelector('.milliseconds').style.display = 'inline';
            } else {
                document.querySelector('.milliseconds').style.display = 'none';
            }
            
            if (showDateCheckbox.checked) {
                const options = {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'};
                dateDisplayEl.textContent = now.toLocaleDateString('zh-CN', options);
                dateDisplayEl.style.display = 'block';
            } else {
                dateDisplayEl.style.display = 'none';
            }
            
            updateGaokaoCountdown();
            updateNextExam();
        }

        // 高性能时间更新
        function updateTime(timestamp) {
            updateTimeDisplay();
            
            frameCount++;
            if (timestamp - lastFpsUpdate >= 1000) {
                currentFps = frameCount;
                frameCount = 0;
                lastFpsUpdate = timestamp;
                
                if (!powerSavingMode && currentFps < fpsThreshold) {
                    powerSavingMode = true;
                    powerSavingModeCheckbox.checked = true;
                    applyPowerSavingMode();
                    showToast(`检测到低帧率 (${currentFps}FPS)，已自动开启节能模式`);
                }
                
                // 更新性能指示器提示
                perfIndicator.setAttribute('data-tooltip', `FPS: ${currentFps} | 内存: ${getMemoryUsage()}MB`);
            }
            
            if (!powerSavingMode) {
                animationFrameId = requestAnimationFrame(updateTime);
            }
        }
        
        // 节能模式更新时间
        function updateTimeInPowerSavingMode() {
            updateTimeDisplay();
        }
        
        // 获取内存使用情况
        function getMemoryUsage() {
            if (performance.memory) {
                return (performance.memory.usedJSHeapSize / (1024 * 1024)).toFixed(2);
            }
            return 'N/A';
        }
        
        // 应用节能模式
        function applyPowerSavingMode() {
            // 取消动画循环
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // 设置每秒更新的定时器
            if (powerSavingInterval) clearInterval(powerSavingInterval);
            powerSavingInterval = setInterval(updateTimeInPowerSavingMode, 1000);
            
            // 关闭毫秒显示
            showMillisecondsCheckbox.checked = false;
            document.querySelector('.milliseconds').style.display = 'none';
            
            // 更新性能指示器
            perfIndicator.className = 'performance-indicator powersave';
            perfIndicator.setAttribute('data-tooltip', `节能模式 - FPS: ${currentFps}`);
            perfStatusEl.className = 'status-indicator offline';
            perfStatusTextEl.textContent = '当前模式: 节能';
            
            saveSettings();
        }
        
        // 应用正常模式
        function applyNormalMode() {
            // 清除节能模式的定时器
            if (powerSavingInterval) {
                clearInterval(powerSavingInterval);
                powerSavingInterval = null;
            }
            
            // 更新性能指示器
            perfIndicator.className = 'performance-indicator normal';
            perfIndicator.setAttribute('data-tooltip', `正常模式 - FPS: ${currentFps}`);
            perfStatusEl.className = 'status-indicator';
            perfStatusTextEl.textContent = '当前模式: 正常';
            
            // 启动动画循环
            animationFrameId = requestAnimationFrame(updateTime);
            
            saveSettings();
        }
        
        // 获取北京时间
        async function fetchBeijingTime() {
            try {
                const response = await fetch('https://api.allorigins.win/get?url=https://f.m.suning.com/api/ct.do00');
                if (!response.ok) throw new Error('时间API请求失败');
                const data = await response.json();
                const timeData = JSON.parse(data.contents);
                const serverTimestamp = timeData.currentTime;
                const serverTime = new Date(serverTimestamp);
                
                // 计算北京时间 (UTC+8)
                const beijingTime = new Date(serverTimestamp);
                beijingTime.setHours(beijingTime.getHours() + 0);
                
                const localTime = new Date();
                timeOffset = beijingTime - localTime;
                lastTimeSync = Date.now();
            } catch (error) {
                console.error('时间同步失败:', error);
                timeOffset = 0;
            }
        }
        
     function updateGaokaoCountdown() {
    const now = new Date(Date.now() + timeOffset);
    const currentYear = now.getFullYear();
    
    // 高考日期范围：6月7日 00:00 至 6月9日 23:59:59.999
    const gaokaoStart = new Date(currentYear, 5, 7);
    const gaokaoEnd = new Date(currentYear, 5, 9, 23, 59, 59, 999);
    
    // 如果当前时间在高考期间内
    if (now >= gaokaoStart && now <= gaokaoEnd) {
        gaokaoTextEl.innerHTML = `${currentYear}年高考进行中！<br>加油！`;
        gaokaoCountdownEl.style.background = 'rgba(106, 17, 203, 0.2)';
        return;
    }
    
    // 确定目标高考日期（当前年或下一年）
    let targetGaokao = gaokaoStart;
    if (now > gaokaoEnd) {
        targetGaokao = new Date(currentYear + 1, 5, 7);
    }
    
    const timeDiff = targetGaokao.getTime() - now.getTime();
    
    // 高考已结束（理论上不会触发，保留安全判断）
    if (timeDiff < 0) {
        gaokaoTextEl.innerHTML = `${targetGaokao.getFullYear()}年高考已结束！`;
        gaokaoCountdownEl.style.background = 'rgba(106, 17, 203, 0.1)';
        return;
    }
    
    // 计算倒计时
    const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
    const hoursDiff = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutesDiff = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
    
    // 高考当天特殊处理（已覆盖在高考期间判断）
    gaokaoTextEl.innerHTML = `距离${targetGaokao.getFullYear()}年高考还有<br>${daysDiff}天${hoursDiff}小时${minutesDiff}分钟`;
    gaokaoCountdownEl.style.background = 'rgba(106, 17, 203, 0.1)';
}
        // 更新下一科考试信息
        function updateNextExam() {
            const now = new Date(Date.now() + timeOffset);
            const currentYear = now.getFullYear();
            
            // 检查是否为高考期间（6月7、8、9日）
            const month = now.getMonth() + 1; // 月份从0开始
            const date = now.getDate();
            
            if (month !== 6 || date < 7 || date > 9) {
                nextExamContainer.style.display = 'none';
                return;
            }
            
            // 显示考试信息框
            nextExamContainer.style.display = 'inline-block';
            
            // 找到下一科考试
            let nextExam = null;
            let minTimeDiff = Infinity;
            
            for (const subject of examSubjects) {
                // 检查科目是否被忽略
                if (ignoredSubjects.includes(subject.name)) continue;
                
                // 解析日期和时间
                const [month, day] = subject.date.split('-');
                const [hours, minutes] = subject.startTime.split(':');
                
                // 创建考试日期对象（当前年份）
                const examDate = new Date(currentYear, parseInt(month) - 1, parseInt(day), 
                    parseInt(hours), parseInt(minutes));
                
                // 计算时间差
                const timeDiff = examDate - now;
                
                // 如果考试已经开始但未结束，则显示该考试
                if (timeDiff < 0 && timeDiff > -1000 * 60 * 60 * 3) {
                    // 考试正在进行中
                    const minutesLeft = Math.floor(Math.abs(timeDiff) / (1000 * 60));
                    nextExamText.innerHTML = `${subject.name}考试中<br>剩余: ${Math.floor(minutesLeft / 60)}时${minutesLeft % 60}分`;
                    return;
                }
                
                // 如果考试尚未开始，且时间差小于当前最小时间差
                if (timeDiff > 0 && timeDiff < minTimeDiff) {
                    minTimeDiff = timeDiff;
                    nextExam = subject;
                }
            }
            
            if (nextExam) {
                // 计算倒计时
                const hoursLeft = Math.floor(minTimeDiff / (1000 * 60 * 60));
                const minutesLeft = Math.floor((minTimeDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                nextExamText.innerHTML = `下一科是: ${nextExam.name}<br>距离开考仅剩: ${hoursLeft}时${minutesLeft}分`;
            } else {
                // 所有考试都已结束
                nextExamText.innerHTML = "所有科目考试结束";
            }
        }
        
        // 本地备用金句库
        const localQuotes = [
            {quote: "宝剑锋从磨砺出，梅花香自苦寒来", author: "出自：《警世贤文》", type: "文学"},
            {quote: "不积跬步，无以至千里；不积小流，无以成江海", author: "出自：荀子《劝学》", type: "文学"},
            {quote: "青春须早为，岂能长少年", author: "出自：孟郊《劝学》", type: "文学"},
            {quote: "成功不是将来才有的，而是从决定去做的那一刻起，持续累积而成", author: "俞敏洪", type: "励志"},
            {quote: "学习如逆水行舟，不进则退", author: "中国谚语", type: "网络"},
            {quote: "时间就像海绵里的水，只要愿挤，总还是有的", author: "鲁迅", type: "文学"},
            {quote: "坚持就是胜利，努力就有收获", author: "佚名", type: "网络"},
            {quote: "书山有路勤为径，学海无涯苦作舟", author: "出自：《增广贤文》", type: "文学"},
            {quote: "机会总是留给有准备的人", author: "路易·巴斯德", type: "励志"},
            {quote: "今天的努力，明天的实力", author: "佚名", type: "网络"}
        ];

        // 显示通知
        function showToast(message) {
            toastMessageEl.textContent = message;
            toastEl.classList.add('show');
            
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }

        // 打字机效果显示金句
        function typewriterEffect(text) {
            isTyping = true;
            let i = 0;
            quoteContentEl.innerHTML = '';
            quoteAuthorEl.textContent = '';
            quoteTypeEl.textContent = '';
            
            const typewriterInterval = setInterval(() => {
                if (i < text.length) {
                    quoteContentEl.innerHTML = text.substring(0, i + 1) + '<span class="cursor"></span>';
                    i++;
                } else {
                    clearInterval(typewriterInterval);
                    isTyping = false;
                    quoteContentEl.innerHTML = text;
                }
            }, 50);
        }
        
        // 获取金句
        async function fetchQuote() {
            if (isTyping) return;
            
            // 检查保底机制 - 每十句保底一句拓展金句
            let forceExtension = false;
            if (enableQuoteGuarantee && consecutiveNonExtension >= 9 && 
                extensionTypeCheckbox.checked && extensionQuotes.length > 0) {
                forceExtension = true;
                consecutiveNonExtension = 0;
            }
            
            // 随机选择类型，包括可能的扩展类型
            let randomType = quoteTypes[Math.floor(Math.random() * quoteTypes.length)];
            
            // 如果选择了扩展类型并且有扩展金句，或者强制使用扩展金句
            if ((forceExtension || randomType === 'm') && extensionTypeCheckbox.checked && extensionQuotes.length > 0) {
                const randomIndex = Math.floor(Math.random() * extensionQuotes.length);
                const quote = extensionQuotes[randomIndex];
                
                quoteContentEl.innerHTML = '';
                quoteAuthorEl.textContent = '';
                quoteTypeEl.textContent = '';
                
                typewriterEffect(quote.hitokoto);
                
                setTimeout(() => {
                    let authorInfo = '';
                    if (quote.from_who) {
                        authorInfo = quote.from_who;
                        if (quote.from) authorInfo += ` · ${quote.from}`;
                    } else if (quote.from) {
                        authorInfo = `出自：${quote.from}`;
                    } else {
                        authorInfo = '未知';
                    }
                    
                    quoteAuthorEl.textContent = `—— ${authorInfo}`;
                    quoteTypeEl.textContent = getTypeName(quote.type);
                }, quote.hitokoto.length * 50 + 300);
                
                apiStatusEl.className = 'status-indicator';
                apiStatusTextEl.textContent = '扩展金句';
                resetQuoteTimer();
                return;
            }
            
            // 正常从API获取金句
            try {
                let data = null;
                for (let i = 0; i < apiUrls.length; i++) {
                    try {
                        const response = await fetch(`${apiUrls[i]}?c=${randomType}&encode=json`);
                        if (!response.ok) throw new Error('API请求失败');
                        data = await response.json();
                        break;
                    } catch (error) {
                        if (i === apiUrls.length - 1) throw error;
                    }
                }
                
                quoteContentEl.innerHTML = '';
                quoteAuthorEl.textContent = '';
                quoteTypeEl.textContent = '';
                
                typewriterEffect(data.hitokoto);
                
                setTimeout(() => {
                    let authorInfo = '';
                    if (data.from_who) {
                        authorInfo = data.from_who;
                        if (data.from) authorInfo += ` · ${data.from}`;
                    } else if (data.from) {
                        authorInfo = `出自：${data.from}`;
                    } else {
                        authorInfo = '未知';
                    }
                    
                    quoteAuthorEl.textContent = `—— ${authorInfo}`;
                    quoteTypeEl.textContent = getTypeName(data.type);
                }, data.hitokoto.length * 50 + 300);
                
                apiStatusEl.className = 'status-indicator';
                apiStatusTextEl.textContent = 'API正常';
                resetQuoteTimer();
                
                // 增加非拓展金句计数
                if (enableQuoteGuarantee && data.type !== 'm') {
                    consecutiveNonExtension++;
                }
            } catch (error) {
                console.error('获取金句失败:', error);
                const randomIndex = Math.floor(Math.random() * localQuotes.length);
                const localQuote = localQuotes[randomIndex];
                
                typewriterEffect(localQuote.quote);
                
                setTimeout(() => {
                    quoteAuthorEl.textContent = `—— ${localQuote.author}`;
                    quoteTypeEl.textContent = localQuote.type;
                }, localQuote.quote.length * 50 + 300);
                
                apiStatusEl.className = 'status-indicator offline';
                apiStatusTextEl.textContent = '使用本地金句';
                resetQuoteTimer();
                showToast('金句API不可用，已使用本地金句');
                
                // 增加非拓展金句计数
                if (enableQuoteGuarantee) {
                    consecutiveNonExtension++;
                }
            }
        }
        
        // 获取类型名称
        function getTypeName(type) {
            const typeMap = {
                'a': '动画', 'b': '漫画', 'c': '游戏', 'd': '文学', 'e': '原创',
                'f': '网络', 'g': '其他', 'h': '影视', 'i': '诗词', 'j': '网易云',
                'k': '哲学', 'l': '抖机灵', 'm': '拓展'
            };
            return typeMap[type] || type;
        }
        
        // 应用背景
        function applyBackground(url, avoidCache = true, showNotification = false) {
            let finalUrl = url;
            
            document.body.style.background = '';
            document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = '';
            
            if (avoidCache && url.startsWith('http')) {
                const separator = url.includes('?') ? '&' : '?';
                finalUrl = `${url}${separator}t=${Date.now()}`;
            }
            
            if (finalUrl !== currentBgUrl) {
                if (finalUrl) {
                    document.body.style.background = `linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('${finalUrl}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                } else {
                    // 无背景时使用默认渐变
                    document.body.style.background = `linear-gradient(135deg, var(--primary), var(--secondary))`;
                }
                currentBgUrl = finalUrl;
                
                if (showNotification) {
                    showToast('背景图片已成功应用！');
                }
                
                if (showBgProgressCheckbox.checked && finalUrl && !finalUrl.startsWith('data:') && currentPreset !== 'bing') {
                    bgProgressEl.style.display = 'block';
                } else {
                    bgProgressEl.style.display = 'none';
                }
            }
        }
        
        // 预设背景配置
        const bgPresets = {
            none: '',
            weimei: 'https://t.alcy.cc/fj',
            bluearchive: 'https://rba.kanostar.top/adapt',
            anime: 'https://imgapi.xl0408.top/index.php',
            yuanshen: 'https://api.suyanw.cn/api/ys',
            random: [
                'https://t.alcy.cc/fj',
                'https://rba.kanostar.top/adapt',
                'https://imgapi.xl0408.top/index.php',
                'https://api.suyanw.cn/api/ys'
            ]
        };
        // 应用预设背景
        function applyPresetBackground(preset, avoidCache = false, showNotification = false) {
            currentPreset = preset;
            customBg = null;
            
            localStorage.setItem('backgroundPreset', preset);
            localStorage.removeItem('customBackground');
            
            if (bgInterval) clearInterval(bgInterval);
            
            if (preset === 'random') {
                changeRandomBg(avoidCache, showNotification);
                bgInterval = setInterval(() => changeRandomBg(true, false), bgIntervalTime * 60 * 1000);
            } else {
                const url = bgPresets[preset];
                applyBackground(url, avoidCache, showNotification);
                
                bgInterval = setInterval(() => {
                    applyPresetBackground(preset, true, false);
                }, bgIntervalTime * 60 * 1000);
            }
            
            resetBgTimer();
            updatePresetButtons(preset);
        }
        
        // 更改随机背景
        function changeRandomBg(avoidCache = true, showNotification = false) {
            const randomIndex = Math.floor(Math.random() * bgPresets.random.length);
            const randomUrl = bgPresets.random[randomIndex];
            applyBackground(randomUrl, avoidCache, showNotification);
            resetBgTimer();
        }
        
        // 更新预设按钮状态
        function updatePresetButtons(activePreset) {
            presetBtns.forEach(btn => {
                if (btn.dataset.preset === activePreset) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // 应用自定义背景
        function applyCustomBackground(url, showNotification = true) {
            customBg = url;
            currentPreset = null;
            
            localStorage.setItem('customBackground', url);
            localStorage.removeItem('backgroundPreset');
            
            updatePresetButtons(null);
            
            if (bgInterval) clearInterval(bgInterval);
            
            applyBackground(url, false, showNotification);
            
            bgInterval = setInterval(() => {
                applyBackground(url, true, false);
            }, bgIntervalTime * 60 * 1000);
            
            resetBgTimer();
        }
        
        // 切换主题
        function toggleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            currentTheme = themes[currentThemeIndex];
            
            document.body.classList.remove('dark-theme', 'ocean-theme', 'forest-theme', 
                'sunset-theme', 'midnight-theme', 'sakura-theme');
            
            if (currentTheme !== 'light') {
                document.body.classList.add(`${currentTheme}-theme`);
            }
            
            localStorage.setItem('theme', currentTheme);
            localStorage.setItem('themeIndex', currentThemeIndex);
        }
        
        // 全屏功能
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`全屏请求错误: ${err.message}`);
                });
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.innerHTML += '<span class="tooltip">退出全屏</span>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    fullscreenBtn.innerHTML += '<span class="tooltip">全屏显示</span>';
                }
            }
        }
        
        // 切换设置面板
function toggleSettings() {
    // 显示验证模态框
    const authModal = document.getElementById('authModal');
    authModal.style.display = 'flex';
    
    // 生成验证码
    const currentCode = generateAuthCode();



// 保存当前设置到临时变量
tempSettings = getCurrentFormSettings();

    // 存储当前验证码
    window.currentAuthCode = currentCode;
    
    tempSettings = getCurrentFormSettings();
    // 设置确认按钮事件
    document.getElementById('confirmAuthBtn').onclick = function() {
        const inputCode = document.getElementById('authCode').value;
        
        if (inputCode === currentCode) {
            // 验证成功
            authModal.style.display = 'none';
            containerEl.classList.add('settings-open');
            refreshBtnEl.classList.add('hidden');
        } else {
            // 验证失败
            showToast('验证码错误，请重新输入');
            document.getElementById('authCode').value = '';
            document.getElementById('authCode').focus();
        }
    };
    
    // 设置取消按钮事件
    document.getElementById('cancelAuthBtn').onclick = function() {
        authModal.style.display = 'none';
    };
}

        // 获取当前表单设置
        function getCurrentFormSettings() {
            const settings = {
                showDate: showDateCheckbox.checked,
                showSeconds: showSecondsCheckbox.checked,
                showMilliseconds: showMillisecondsCheckbox.checked,
                showQuoteProgress: showQuoteProgressCheckbox.checked,
                showBgProgress: showBgProgressCheckbox.checked,
                quoteTypes: Array.from(document.querySelectorAll('input[name="quoteType"]:checked')).map(cb => cb.value),
                quoteInterval: parseInt(quoteIntervalInput.value) || 1,
                bgInterval: parseInt(bgIntervalInput.value) || 30,
                bgUrl: bgUrlInput.value,
                currentPreset: currentPreset,
                powerSavingMode: powerSavingMode,
                hidePerfIndicator: hidePerfIndicatorCheckbox.checked,
                fpsThreshold: parseInt(fpsThresholdInput.value) || 30,
                memoryThreshold: parseInt(memoryThresholdInput.value) || 500,
                displayPriority: document.querySelector('input[name="displayPriority"]:checked').value,
                enableQuoteGuarantee: enableQuoteGuarantee,
                ignoredSubjects: ignoredSubjects
            };
            
            return settings;
        }
        
        // 应用设置到表单
        function applyFormSettings(settings) {
            showDateCheckbox.checked = settings.showDate;
            showSecondsCheckbox.checked = settings.showSeconds;
            showMillisecondsCheckbox.checked = settings.showMilliseconds;
            showQuoteProgressCheckbox.checked = settings.showQuoteProgress;
            showBgProgressCheckbox.checked = settings.showBgProgress;
            
            document.querySelectorAll('input[name="quoteType"]').forEach(checkbox => {
                checkbox.checked = settings.quoteTypes.includes(checkbox.value);
            });
            
            quoteIntervalInput.value = settings.quoteInterval;
            bgIntervalInput.value = settings.bgInterval;
            
            bgUrlInput.value = settings.bgUrl;
            currentPreset = settings.currentPreset;
            updatePresetButtons(currentPreset);
            
            powerSavingMode = settings.powerSavingMode || false;
            powerSavingModeCheckbox.checked = powerSavingMode;
            hidePerfIndicatorCheckbox.checked = settings.hidePerfIndicator || false;
            fpsThreshold = settings.fpsThreshold || 30;
            memoryThreshold = settings.memoryThreshold || 500;
            enableQuoteGuarantee = settings.enableQuoteGuarantee !== undefined ? settings.enableQuoteGuarantee : true;
            ignoredSubjects = settings.ignoredSubjects || [];
            
            // 应用显示偏好设置
            document.body.classList.remove('quote-priority', 'time-priority');
            if (settings.displayPriority === 'time') {
                document.body.classList.add('time-priority');
                timePriorityRadio.checked = true;
            } else {
                document.body.classList.add('quote-priority');
                quotePriorityRadio.checked = true;
            }
            
            perfIndicator.style.display = hidePerfIndicatorCheckbox.checked ? 'none' : 'flex';
            
            // 应用被忽略的科目设置
            document.querySelectorAll('input[name="ignoredSubject"]').forEach(checkbox => {
                checkbox.checked = !ignoredSubjects.includes(checkbox.value);
            });
            
            if (powerSavingMode) {
                applyPowerSavingMode();
            } else {
                applyNormalMode();
            }
        }
        
        // 全选金句类型
        function selectAllTypes() {
            document.querySelectorAll('input[name="quoteType"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        // 全不选金句类型
        function deselectAllTypes() {
            document.querySelectorAll('input[name="quoteType"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // 保存设置
        function saveSettings() {
            const settings = {
                showDate: showDateCheckbox.checked,
                showSeconds: showSecondsCheckbox.checked,
                showMilliseconds: showMillisecondsCheckbox.checked,
                showQuoteProgress: showQuoteProgressCheckbox.checked,
                showBgProgress: showBgProgressCheckbox.checked,
                quoteTypes: Array.from(document.querySelectorAll('input[name="quoteType"]:checked')).map(cb => cb.value),
                theme: currentTheme,
                themeIndex: currentThemeIndex,
                quoteInterval: quoteInterval,
                bgInterval: bgIntervalTime,
                powerSavingMode: powerSavingMode,
                hidePerfIndicator: hidePerfIndicatorCheckbox.checked,
                fpsThreshold: parseInt(fpsThresholdInput.value) || 30,
                memoryThreshold: parseInt(memoryThresholdInput.value) || 500,
                displayPriority: document.querySelector('input[name="displayPriority"]:checked').value,
                enableQuoteGuarantee: enableQuoteGuarantee,
                ignoredSubjects: ignoredSubjects
            };
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
        }
        
        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('appSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                showDateCheckbox.checked = settings.showDate;
                showSecondsCheckbox.checked = settings.showSeconds;
                showMillisecondsCheckbox.checked = settings.showMilliseconds;
                showQuoteProgressCheckbox.checked = settings.showQuoteProgress || true;
                showBgProgressCheckbox.checked = settings.showBgProgress || true;
                
                document.querySelector('.quote-progress-container').style.display = 
                    showQuoteProgressCheckbox.checked ? 'block' : 'none';
                bgProgressEl.style.display = showBgProgressCheckbox.checked ? 'block' : 'none';
                
                document.querySelectorAll('input[name="quoteType"]').forEach(checkbox => {
                    checkbox.checked = settings.quoteTypes.includes(checkbox.value);
                });
                
                quoteTypes = settings.quoteTypes.length > 0 ? settings.quoteTypes : ['k'];
                
                if (settings.quoteTypes.length === 0) {
                    containerEl.classList.add('quote-hidden');
                } else {
                    containerEl.classList.remove('quote-hidden');
                }
                
                currentTheme = settings.theme || 'light';
                currentThemeIndex = settings.themeIndex || 0;
                
                document.body.classList.remove('dark-theme', 'ocean-theme', 'forest-theme', 
                    'sunset-theme', 'midnight-theme', 'sakura-theme');
                
                if (currentTheme !== 'light') {
                    document.body.classList.add(`${currentTheme}-theme`);
                }
                
                // 应用显示偏好设置
                document.body.classList.remove('quote-priority', 'time-priority');
                if (settings.displayPriority === 'time') {
                    document.body.classList.add('time-priority');
                    timePriorityRadio.checked = true;
                } else {
                    document.body.classList.add('quote-priority');
                    quotePriorityRadio.checked = true;
                }
                
                if (settings.quoteInterval) {
                    quoteInterval = settings.quoteInterval;
                    quoteIntervalInput.value = quoteInterval;
                }
                
                if (settings.bgInterval) {
                    bgIntervalTime = settings.bgInterval;
                    bgIntervalInput.value = bgIntervalTime;
                }
                
                powerSavingMode = settings.powerSavingMode || false;
                powerSavingModeCheckbox.checked = powerSavingMode;
                hidePerfIndicatorCheckbox.checked = settings.hidePerfIndicator || false;
                fpsThreshold = settings.fpsThreshold || 30;
                memoryThreshold = settings.memoryThreshold || 500;
                enableQuoteGuarantee = settings.enableQuoteGuarantee !== undefined ? settings.enableQuoteGuarantee : true;
                ignoredSubjects = settings.ignoredSubjects || [];
                
                perfIndicator.style.display = hidePerfIndicatorCheckbox.checked ? 'none' : 'flex';
                
                // 应用被忽略的科目设置
                document.querySelectorAll('input[name="ignoredSubject"]').forEach(checkbox => {
                    checkbox.checked = !ignoredSubjects.includes(checkbox.value);
                });
                
                if (powerSavingMode) {
                    applyPowerSavingMode();
                }
            } else {
                showDateCheckbox.checked = true;
                showSecondsCheckbox.checked = true;
                showMillisecondsCheckbox.checked = false;
                showQuoteProgressCheckbox.checked = true;
                showBgProgressCheckbox.checked = true;
                selectAllTypes();
                quoteTypes = Array.from(document.querySelectorAll('input[name="quoteType"]')).map(cb => cb.value);
                quoteIntervalInput.value = 1;
                bgIntervalInput.value = 30;
                powerSavingModeCheckbox.checked = false;
                hidePerfIndicatorCheckbox.checked = false;
                quotePriorityRadio.checked = true;
                document.body.classList.add('quote-priority');
                enableQuoteGuarantee = true;
                ignoredSubjects = [];
                saveSettings();
            }
            
            document.querySelector('.quote-progress-container').style.display = 
                showQuoteProgressCheckbox.checked ? 'block' : 'none';
            bgProgressEl.style.display = showBgProgressCheckbox.checked ? 'block' : 'none';
            
            const savedPreset = localStorage.getItem('backgroundPreset');
            const savedCustomBg = localStorage.getItem('customBackground');
            
            if (savedCustomBg) {
                applyCustomBackground(savedCustomBg, false);
                bgUrlInput.value = savedCustomBg;
            } else if (savedPreset) {
                applyPresetBackground(savedPreset, false, false);
                bgUrlInput.value = '';
            } else {
                applyPresetBackground('weimei', false, false);
            }
        }
        
        // 重置金句计时器
        function resetQuoteTimer() {
            if (quoteAnimationFrame) {
                cancelAnimationFrame(quoteAnimationFrame);
                quoteAnimationFrame = null;
            }
            
            quoteStartTime = Date.now();
            quoteDuration = quoteInterval * 60 * 1000;
            lastProgressUpdate = quoteStartTime;
            
            function updateQuoteProgress() {
                const now = Date.now();
                const elapsed = now - quoteStartTime;
                const remaining = quoteDuration - elapsed;
                let progress = Math.min(100, (remaining / quoteDuration) * 100);
                
                quoteProgressBar.style.transform = `scaleX(${progress / 100})`;
                quoteProgressBar.style.backgroundColor = remaining < 15000 ? '#e74c3c' : '#2ecc71';
                
                if (now - lastProgressUpdate > 10000) {
                    lastProgressUpdate = now;
                    if (elapsed >= quoteDuration) {
                        fetchQuote();
                        return;
                    }
                }
                
                if (elapsed < quoteDuration) {
                    quoteAnimationFrame = requestAnimationFrame(updateQuoteProgress);
                } else {
                    quoteAnimationFrame = null;
                    fetchQuote();
                }
            }
            
            quoteAnimationFrame = requestAnimationFrame(updateQuoteProgress);
        }
        
        // 重置背景计时器
        function resetBgTimer() {
            if (bgAnimationFrame) {
                cancelAnimationFrame(bgAnimationFrame);
                bgAnimationFrame = null;
            }
            
            bgStartTime = Date.now();
            bgDuration = bgIntervalTime * 60 * 1000;
            lastProgressUpdate = bgStartTime;
            
            function updateBgProgress() {
                const now = Date.now();
                const elapsed = now - bgStartTime;
                const remaining = bgDuration - elapsed;
                let progress = Math.min(100, (remaining / bgDuration) * 100);
                
                bgProgressBar.style.transform = `scaleX(${progress / 100})`;
                bgProgressBar.style.backgroundColor = remaining < 15000 ? '#e74c3c' : '#2ecc71';
                
                if (now - lastProgressUpdate > 10000) {
                    lastProgressUpdate = now;
                    if (elapsed >= bgDuration) {
                        resetBgTimer();
                        return;
                    }
                }
                
                if (elapsed < bgDuration) {
                    bgAnimationFrame = requestAnimationFrame(updateBgProgress);
                } else {
                    bgAnimationFrame = null;
                    resetBgTimer();
                }
            }
            
            bgAnimationFrame = requestAnimationFrame(updateBgProgress);
        }
        
        // 重置为默认设置
        function resetToDefault() {
            if (confirm('确定要重置所有设置吗？此操作不可撤销！')) {
                localStorage.removeItem('appSettings');
                localStorage.removeItem('backgroundPreset');
                localStorage.removeItem('customBackground');
                localStorage.removeItem('extensionQuotes');
                loadSettings();
                fetchQuote();
                showToast('设置已重置为默认值！');
            }
        }
function generateAuthCode() {
    const secret = 'fz222324';
    const now = new Date();
    
    // 生成时间戳 (YYYYMMDDHHMM)
    const timestamp = [
        now.getFullYear(),
        String(now.getMonth() + 1).padStart(2, '0'),
        String(now.getDate()).padStart(2, '0'),
        String(now.getHours()).padStart(2, '0'),
        String(now.getMinutes()).padStart(2, '0')
    ].join('');
    
    // 数据拼接
    const data = timestamp + secret;
    
    // 使用SHA-256哈希
    const hash = CryptoJS.SHA256(data);
    const hashHex = hash.toString(CryptoJS.enc.Hex);
    
    // 将哈希值转换为BigInt
    const bigIntValue = BigInt('0x' + hashHex);
    
    // Base58字符集 (去除了0、O、I、l等容易混淆的字符)
    const base58Chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    
    // Base58编码
    let base58 = '';
    let n = bigIntValue;
    while (n > 0) {
        const remainder = Number(n % 58n);
        n = n / 58n;
        base58 = base58Chars[remainder] + base58;
    }
    
    // 提取6位偶数索引字符
    let authCode = '';
    for (let i = 0; i <= 10; i += 2) {
        if (base58[i]) {
            authCode += base58[i];
        }
        if (authCode.length >= 6) break;
    }
    
    // 如果不足6位，用字符集开头的字符填充
    while (authCode.length < 6) {
        authCode += base58Chars[0];
    }
    
    return authCode;
}

        // 初始化
        function init() {
            fetchBeijingTime();
            setInterval(fetchBeijingTime, 5 * 60 * 1000);
            
            loadSettings();
            animationFrameId = requestAnimationFrame(updateTime);
            fetchQuote();
            startPerformanceMonitor();
            initExtensionQuotes();
    // 正确绑定设置面板的取消按钮
    document.getElementById('cancelSettingsBtn').addEventListener('click', function() {
        // 应用之前保存的临时设置
        if (tempSettings) {
            applyFormSettings(tempSettings);
        }
        
        // 关闭设置面板
        containerEl.classList.remove('settings-open');
        refreshBtnEl.classList.remove('hidden');
        
        // 显示操作提示
        showToast('设置已恢复');
    });

            
            // 启动防休眠模式
            enableNoSleep();
            
            // 监听扩展类型复选框变化
            extensionTypeCheckbox.addEventListener('change', () => {
                if (extensionTypeCheckbox.checked) {
                    // 如果之前没有拓展金句数据，重新下载
                    if (!localStorage.getItem('extensionQuotes')) {
                        downloadExtensionQuotes();
                    } else {
                        updateExtensionStatus();
                    }
                } else {
                    // 删除拓展金句数据
                    localStorage.removeItem('extensionQuotes');
                    updateExtensionStatus();
                }
                saveSettings();
            });
            
            // 监听显示偏好变化
            quotePriorityRadio.addEventListener('change', () => {
                if (quotePriorityRadio.checked) {
                    document.body.classList.remove('time-priority');
                    document.body.classList.add('quote-priority');
                }
                saveSettings();
            });
            
            timePriorityRadio.addEventListener('change', () => {
                if (timePriorityRadio.checked) {
                    document.body.classList.remove('quote-priority');
                    document.body.classList.add('time-priority');
                }
                saveSettings();
            });
            
            // 监听被忽略科目变化
            document.querySelectorAll('input[name="ignoredSubject"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const subject = checkbox.value;
                    if (checkbox.checked) {
                        // 从忽略列表中移除
                        ignoredSubjects = ignoredSubjects.filter(s => s !== subject);
                    } else {
                        // 添加到忽略列表
                        if (!ignoredSubjects.includes(subject)) {
                            ignoredSubjects.push(subject);
                        }
                    }
                    saveSettings();
                    updateNextExam(); // 立即更新考试信息
                });
            });
            
            // 保底机制按钮
            toggleGuaranteeBtn.addEventListener('click', () => {
                enableQuoteGuarantee = !enableQuoteGuarantee;
                toggleGuaranteeBtn.innerHTML = enableQuoteGuarantee ? 
                    '<i class="fas fa-shield-alt"></i> 保底机制: 开' : 
                    '<i class="fas fa-shield-alt"></i> 保底机制: 关';
                showToast(`金句保底机制已${enableQuoteGuarantee ? '开启' : '关闭'}`);
                saveSettings();
            });
// 导入按钮事件
document.getElementById('importExtBtn').addEventListener('click', function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                const content = await file.text();
                const quotes = JSON.parse(content);
                
                // 验证格式
                if (!Array.isArray(quotes) || !quotes.every(q => q.hitokoto && q.from)) {
                    throw new Error('无效的JSON格式');
                }
                
                extensionQuotes = quotes;
                localStorage.setItem('extensionQuotes', JSON.stringify(quotes));
                updateExtensionStatus();
                showToast('扩展金句已成功导入！');
            } catch (error) {
                console.error('导入失败:', error);
                showToast('导入失败: ' + error.message);
            }
        }
    };
    input.click();
});

// 导出按钮事件
document.getElementById('exportExtBtn').addEventListener('click', function() {
    const quotes = localStorage.getItem('extensionQuotes');
    if (!quotes) {
        showToast('没有可导出的扩展金句');
        return;
    }
    
    const blob = new Blob([quotes], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `扩展金句_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('扩展金句已导出');
});
            
            refreshBtnEl.addEventListener('click', fetchQuote);
            themeBtn.addEventListener('click', toggleTheme);
            settingsBtn.addEventListener('click', toggleSettings);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            selectAllBtn.addEventListener('click', selectAllTypes);
            deselectAllBtn.addEventListener('click', deselectAllTypes);
            resetBtn.addEventListener('click', resetToDefault);
            downloadExtBtn.addEventListener('click', downloadExtensionQuotes);
            
            powerSavingModeCheckbox.addEventListener('change', () => {
                powerSavingMode = powerSavingModeCheckbox.checked;
                if (powerSavingMode) {
                    applyPowerSavingMode();
                } else {
                    applyNormalMode();
                }
            });
            
            hidePerfIndicatorCheckbox.addEventListener('change', () => {
                perfIndicator.style.display = hidePerfIndicatorCheckbox.checked ? 'none' : 'flex';
                saveSettings();
            });
            
saveSettingsBtn.addEventListener('click', () => {
    quoteInterval = Math.max(1, parseInt(quoteIntervalInput.value) || 1);
    bgIntervalTime = Math.max(1, parseInt(bgIntervalInput.value) || 30);
    fpsThreshold = Math.max(15, Math.min(60, parseInt(fpsThresholdInput.value) || 30));
    memoryThreshold = Math.max(100, Math.min(1000, parseInt(memoryThresholdInput.value) || 500));
    
    const selectedTypes = [];
    document.querySelectorAll('input[name="quoteType"]:checked').forEach(cb => {
        selectedTypes.push(cb.value);
    });

    if (selectedTypes.length > 0) {
        quoteTypes = selectedTypes;
        containerEl.classList.remove('quote-hidden');
    } else {
        quoteTypes = ['k'];
        containerEl.classList.add('quote-hidden');
    }
    
    // 如果用户关闭了拓展金句，删除相关数据
    if (!extensionTypeCheckbox.checked) {
        localStorage.removeItem('extensionQuotes');
        updateExtensionStatus();
    }
    
    resetQuoteTimer();
    resetBgTimer();
    
    document.querySelector('.quote-progress-container').style.display = 
        showQuoteProgressCheckbox.checked ? 'block' : 'none';
    bgProgressEl.style.display = showBgProgressCheckbox.checked ? 'block' : 'none';
    
    saveSettings(); // 保存设置到localStorage
    
    // 直接关闭设置面板，不需要验证
    containerEl.classList.remove('settings-open');
    refreshBtnEl.classList.remove('hidden');
    showToast('设置已保存');
});  // 确保这里有闭合括号和分号
            
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const preset = btn.dataset.preset;
                    currentPreset = preset;
                    customBg = null;
                    updatePresetButtons(preset);
                    applyPresetBackground(preset, true, true);
                });
            });
            
            refreshQuoteBtn.addEventListener('click', () => {
                fetchQuote();
                showToast('金句已成功更换！');
            });
            
            refreshBgBtn.addEventListener('click', () => {
                if (currentPreset === 'random') {
                    changeRandomBg(true, true);
                } else if (currentPreset) {
                    applyPresetBackground(currentPreset, true, true);
                } else if (customBg) {
                    applyBackground(customBg, true, true);
                }
            });
            
            saveBgBtn.addEventListener('click', () => {
                const url = bgUrlInput.value.trim();
                if (url) {
                    customBg = url;
                    currentPreset = null;
                    localStorage.setItem('customBackground', url);
                    localStorage.removeItem('backgroundPreset');
                    updatePresetButtons(null);
                    if (bgInterval) clearInterval(bgInterval);
                    applyBackground(url, false, true);
                    bgInterval = setInterval(() => {
                        applyBackground(url, true, false);
                    }, bgIntervalTime * 60 * 1000);
                    resetBgTimer();
                }
            });
            
            bgLocalBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = event.target.result;
                            bgUrlInput.value = dataUrl;
                            customBg = dataUrl;
                            currentPreset = null;
                            localStorage.setItem('customBackground', dataUrl);
                            localStorage.removeItem('backgroundPreset');
                            updatePresetButtons(null);
                            if (bgInterval) clearInterval(bgInterval);
                            applyBackground(dataUrl, false, true);
                            bgInterval = setInterval(() => {
                                applyBackground(dataUrl, true, false);
                            }, bgIntervalTime * 60 * 1000);
                            resetBgTimer();
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            });
            
            showQuoteProgressCheckbox.addEventListener('change', () => {
                document.querySelector('.quote-progress-container').style.display = 
                    showQuoteProgressCheckbox.checked ? 'block' : 'none';
                saveSettings();
            });
            
            showBgProgressCheckbox.addEventListener('change', () => {
                bgProgressEl.style.display = showBgProgressCheckbox.checked ? 'block' : 'none';
                saveSettings();
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
<div class="auth-modal" id="authModal">
    <div class="auth-content">
        <h3><i class="fas fa-lock"></i> 安全验证</h3>
        <p>请输入动态验证密钥以访问设置面板</p>
        <div class="auth-input">
            <input type="text" id="authCode" placeholder="输入6位验证码" maxlength="6">
        </div>
        <div class="auth-buttons">
            <button class="btn" id="confirmAuthBtn">确认</button>
            <button class="btn btn-outline" id="cancelAuthBtn">取消</button>
        </div>
    </div>
</div>
</body>
</html>